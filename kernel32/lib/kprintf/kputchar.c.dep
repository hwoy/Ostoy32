#include <stdio.h>
#include <vga.h>
#include <kprintf.h>


static void putnl(void);

int kputchar(int ch, unsigned short bg, unsigned short fg)
{
		unsigned int x,y,i;
		
		get_cur(&x,&y);
		
		 if(ch=='\n')
		{
			putnl();
			return (unsigned char)ch;
		}
		
		
		else if(ch=='\r')
	{	
		set_cur(0,y);
		return (unsigned char)ch;
	}	
		
	else if(ch=='\t')
	{	
		for(i=0;i<HTAB;i++)
		{
				if(x>=(COL-1))
				{
					return (unsigned char)ch;
				}
			kputchar(SPACEBAR,bg,fg);
		}
		return (unsigned char)ch;
	}
	
	else if(ch=='\b')
	{	
		if(x==0)
		{
			if(y!=0)
			{
				y--;
				
				for(i=0;i<COL;i++)
				{
					if(!(get_pix(i,y)&0x00ff)) {break;}
				}
				i=(i>=COL) ? COL-1:i;
				x= (i==0) ? 0 : i;
			}
			
		}
		else
		{
			x--;
		}
		set_cur(x,y);
		kputchar('\0',bg,fg);
		set_cur(x,y);

		return (unsigned char)ch;
	}
	
	
	pix(x,y,bg,fg,ch);
	if(x>=COL-1)
	{
		if(y>=ROW-1)
		{
			scrollup(1);
			y=ROW-1;
		}
		else
		{
			y++;
		}
		x=0;
		
	}
	else
	{
		x++;
	}
	
		set_cur(x,y);
		
		return (unsigned char)ch;
}

static void putnl(void)
{
unsigned int x,y;
get_cur(&x,&y);
if(y>=(ROW-1))
{
	scrollup(1);
	y=ROW-1;
}
else
{
	y++;
}
set_cur(0,y);
}
